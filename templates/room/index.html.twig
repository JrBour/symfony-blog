{% extends 'room/layout.html.twig' %}

{% block title %}Messages{% endblock %}

{% block body %}
    <h1>Salons</h1>

    <div class="room__content">
        <ul class="room">
            {% for user in users %}
                {% if user.room[0] is defined %}
                    <li class="room__list display_room" id="{{ user.room[0].id }}">
                        <img src="{{ user.image }}" alt="{{ user.username }}">
                        <p class="create-new-room">{{ user.username }}</p>
                    </li>
                {% else %}
                    <li class="room__list create-new-room" id="{{ user.id }}">
                        <img src="{{ user.image }}" alt="{{ user.username }}">
                        <p class="create-new-room">{{ user.username }}</p>
                    </li>
                {% endif %}
            {% else %}
                <li>Vous n'avez aucun amis !</li>
            {% endfor %}
        </ul>
        <div id="messages__container">

        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script>
        const createRoom = document.querySelector('.create-new-room');
        const displayRoom = document.querySelector('.display_room');
        const messageContainer = document.querySelector('#messages_container');

        displayRoom.addEventListener('click', async () => {

            let parse = new DOMParser();

            try {
                let response = await fetch(`${window.location.origin}/room/${displayRoom.getAttribute('id')}`);
                if (response.ok) {
                    let data = await response.text();
                    let elementHTML = await parse.parseFromString(data, 'text/html');
                    messageContainer.append(elementHTML.querySelector('#messages__list'));
                }
            }
        });


        createRoom.addEventListener('click', async ()=> {

            try {
                let response = await fetch(`${window.location.origin}/room/new`, {
                    method : 'post',
                    headers : {'X-Requested-With': 'XMLHttpRequest'},
                    body:JSON.stringify({
                        'name' : createRoom.textContent,
                        'picture' : createRoom.firstElementChild.getAttribute('src'),
                        'id' : createRoom.getAttribute('id')
                    })
                });
                if (response.ok) {
                    let data = await response.json();
                    window.location.replace(window.location.href+`${data.id}`);
                } else {
                    console.error(response.status);
                }
            } catch (e) {
                console.error(e);
            }
            console.log(data);
        })

    </script>
{% endblock %}